<div
  class='contenedorVideo full-width'
  style='
    --desfaseY: {{ section.settings.desfase_vertical | default: 0 }}%;
    --desfaseYMovil: {% if section.settings.usar_desfase_escritorio_en_movil %}{{ section.settings.desfase_vertical | default: 0 }}{% else %}{{ section.settings.desfase_vertical_movil | default: 0 }}{% endif %}%;
    --desfaseYFrac: {{ section.settings.desfase_vertical | default: 0 | times: 0.01 }};
    --desfaseYMovilFrac: {% if section.settings.usar_desfase_escritorio_en_movil %}{{ section.settings.desfase_vertical | default: 0 | times: 0.01 }}{% else %}{{ section.settings.desfase_vertical_movil | default: 0 | times: 0.01 }}{% endif %};
    --ratio: {% if section.settings.video_seccion and section.settings.video_seccion.aspect_ratio %}calc(1 / {{ section.settings.video_seccion.aspect_ratio }}){% else %}0.5625{% endif %};
    --nivelZ: {{ section.settings.z_index | default: 0 }};
  '
>
  {% if section.settings.video_seccion %}
    {{
      section.settings.video_seccion
      | video_tag: autoplay: true, loop: true, muted: true, playsinline: true, class: 'videoPantallaCompleta'
    }}
  {% else %}
    <p></p>
  {% endif %}

  {% assign hay_texto = section.settings.video_texto %}
  {% assign hay_boton = section.settings.video_enlace_boton %}
  {% if hay_texto != blank or hay_boton != blank %}
    <div
      class='textoFlotante textoVideo {% case section.settings.posicion_texto | default: 'centro' %}{% when 'centro' %}posCentro{% when 'supIzq' %}posSupIzq{% when 'supDer' %}posSupDer{% when 'infIzq' %}posInfIzq{% when 'infDer' %}posInfDer{% when 'supCentro' %}posSupCentro{% when 'infCentro' %}posInfCentro{% when 'centroDer' %}posCentroDer{% when 'centroIzq' %}posCentroIzq{% endcase %}'
      style='
        color: {{ section.settings.color_texto | default: "#ffffff" }};
        {% if section.settings.mostrar_fondo %} background: {{ section.settings.color_fondo | default: "rgba(0,0,0,0.5)" }}; {% else %} background: transparent; {% endif %}
        max-width: {% if section.settings.max_ancho_ch %}{{ section.settings.max_ancho_ch }}ch{% else %}60ch{% endif %};
        font-size: {% if section.settings.tamano_fuente %}{{ section.settings.tamano_fuente }}px{% else %}18px{% endif %};
        text-align: {{ section.settings.alineacion_texto | default: 'center' }};
        {% assign offx = section.settings.offset_x | default: 16 %}
        {% assign offy = section.settings.offset_y | default: 16 %}
        {% assign unidad = section.settings.unidad_offset | default: 'px' %}
        {% case section.settings.posicion_texto | default: 'centro' %}
          {% when 'supIzq' %} top: {{ offy }}{{ unidad }}; left: {{ offx }}{{ unidad }}; transform: none;
          {% when 'supDer' %} top: {{ offy }}{{ unidad }}; right: {{ offx }}{{ unidad }}; transform: none;
          {% when 'infIzq' %} bottom: {{ offy }}{{ unidad }}; left: {{ offx }}{{ unidad }}; transform: none;
          {% when 'infDer' %} bottom: {{ offy }}{{ unidad }}; right: {{ offx }}{{ unidad }}; transform: none;
          {% when 'supCentro' %} top: {{ offy }}{{ unidad }}; left: 50%; transform: translateX(-50%);
          {% when 'infCentro' %} bottom: {{ offy }}{{ unidad }}; left: 50%; transform: translateX(-50%);
          {% when 'centroDer' %} top: 50%; right: {{ offx }}{{ unidad }}; transform: translateY(-50%);
          {% when 'centroIzq' %} top: 50%; left: {{ offx }}{{ unidad }}; transform: translateY(-50%);
          {% else %} top: 50%; left: 50%; transform: translate(-50%, -50%);
        {% endcase %}
      '
    >
      {% if section.settings.video_texto != blank %}
        {{ section.settings.video_texto }}
      {% endif %}
      {% if section.settings.video_enlace_boton != blank %}
        <div class='enlaceVideo botonDestacado'>
          <a href='{{ section.settings.video_enlace_boton }}' class='videoBoton'>
            {{ section.settings.video_texto_boton | default: 'Ver más' }}
          </a>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

{% schema %}
{
  "name": "Video",
  "settings": [
    {
      "type": "video",
      "id": "video_seccion",
      "label": "Archivo de video"
    },
    {
      "type": "richtext",
      "id": "video_texto",
      "label": "Texto sobre el video"
    },
    {
      "type": "select",
      "id": "posicion_texto",
      "label": "Posición del texto",
      "default": "centro",
      "options": [
        { "value": "centro", "label": "Centrado" },
        { "value": "centroDer", "label": "Centro derecha" },
        { "value": "centroIzq", "label": "Centro izquierda" },
        { "value": "supIzq", "label": "Superior izquierda" },
        { "value": "supDer", "label": "Superior derecha" },
        { "value": "supCentro", "label": "Superior centro" },
        { "value": "infIzq", "label": "Inferior izquierda" },
        { "value": "infDer", "label": "Inferior derecha" },
        { "value": "infCentro", "label": "Inferior centro" }
      ]
    },
    {
      "type": "color",
      "id": "color_texto",
      "label": "Color del texto (opcional)",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "color_fondo",
      "label": "Color de fondo del overlay (opcional)",
      "default": "rgba(0,0,0,0.5)"
    },
    {
      "type": "checkbox",
      "id": "mostrar_fondo",
      "label": "Mostrar fondo detrás del texto",
      "default": true
    },
    {
      "type": "range",
      "id": "max_ancho_ch",
      "label": "Ancho máximo del texto (ch)",
      "min": 20,
      "max": 80,
      "step": 1,
      "default": 60
    },
    {
      "type": "select",
      "id": "unidad_offset",
      "label": "Unidad de separación (px o %)",
      "default": "px",
      "options": [
        { "value": "px", "label": "Pixeles (px)" },
        { "value": "%", "label": "Porcentaje (%)" }
      ],
      "info": "Define la unidad para las separaciones horizontal/vertical del texto superpuesto."
    },
    {
      "type": "range",
      "id": "offset_x",
      "label": "Separación horizontal",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 16,
      "info": "Usa la unidad seleccionada arriba (px o %)."
    },
    {
      "type": "range",
      "id": "offset_y",
      "label": "Separación vertical",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 16,
      "info": "Usa la unidad seleccionada arriba (px o %)."
    },
    {
      "type": "range",
      "id": "tamano_fuente",
      "label": "Tamaño de fuente (px)",
      "min": 12,
      "max": 48,
      "step": 1,
      "default": 18
    },
    {
      "type": "select",
      "id": "alineacion_texto",
      "label": "Alineación del texto",
      "default": "center",
      "options": [
        { "value": "left", "label": "Izquierda" },
        { "value": "center", "label": "Centro" },
        { "value": "right", "label": "Derecha" }
      ]
    },
    {
      "type": "text",
      "id": "video_texto_boton",
      "label": "Texto del botón",
      "default": "Ver más"
    },
    {
      "type": "url",
      "id": "video_enlace_boton",
      "label": "Enlace del botón"
    },
    {
      "type": "header",
      "content": "Desplazamiento y niveles"
    },
    {
      "type": "paragraph",
      "content": "En móvil puedes heredar el desfase de escritorio (opción recomendada) o personalizarlo. El z-index controla el apilado entre secciones; valores más altos quedan por encima."
    },
    {
      "type": "checkbox",
      "id": "usar_desfase_escritorio_en_movil",
      "label": "Usar el desfase de escritorio en móvil",
      "default": true
    },
    {
      "type": "range",
      "id": "desfase_vertical",
      "label": "Desfase vertical (%)",
      "min": -50,
      "max": 50,
      "step": 1,
      "default": 0,
      "info": "Desplaza la sección en porcentaje relativo a su altura. Negativo: sube; Positivo: baja."
    },
    {
      "type": "range",
      "id": "desfase_vertical_movil",
      "label": "Desfase vertical en móvil (%)",
      "min": -50,
      "max": 50,
      "step": 1,
      "default": 0,
      "info": "Valor específico para pantallas pequeñas (≤768px). Si activas \"Usar el desfase de escritorio en móvil\", este valor se ignora."
    },
    {
      "type": "range",
      "id": "z_index",
      "label": "Nivel (z-index)",
      "min": -5,
      "max": 20,
      "step": 1,
      "default": 0,
      "info": "Controla si esta sección queda por encima o por debajo de las vecinas cuando se solapan. Si no ves efecto, revisa si un contenedor padre crea un nuevo contexto de apilado (por ejemplo, con transform u opacity)."
    }
  ],
  "presets": [
    {
      "name": "Video",
      "category": "Decoraciones"
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .videoPantallaCompleta {
    width: 100%;
    height: 100%;
    min-height: 600px;
    object-fit: cover;
  }

  .contenedorVideo {
    position: relative;
    width: 100%;
    height: 100%;
    transform: translateY(var(--desfaseY, 0%));
    will-change: transform;
    z-index: var(--nivelZ, 0);
    margin-bottom: calc(var(--desfaseYFrac, 0) * var(--ratio, 0.5625) * 100%);
  }
  .textoFlotante {
    position: absolute;
    max-width: min(90%, 60ch);
    color: #fff;
    background: rgba(0, 0, 0, 0.5);
    padding: 0.75rem 1rem;
  }

  .textoFlotante.posCentro {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  .textoFlotante.posSupIzq {
    top: 1rem;
    left: 1rem;
  }
  .textoFlotante.posSupDer {
    top: 1rem;
    right: 1rem;
  }
  .textoFlotante.posSupCentro {
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
  }
  .textoFlotante.posInfCentro {
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
  }
  .textoFlotante.posCentroDer {
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    text-align: right;
  }
  .textoFlotante.posCentroIzq {
    top: 50%;
    left: 1rem;
    transform: translateY(-50%);
    text-align: left;
  }
  .textoFlotante.posInfIzq {
    bottom: 1rem;
    left: 1rem;
  }
  .textoFlotante.posInfDer {
    bottom: 1rem;
    right: 1rem;
  }

  .enlaceVideo {
    margin-top: 1em;
  }
  @media (max-width: 768px) {
    .contenedorVideo {
      transform: translateY(var(--desfaseYMovil, var(--desfaseY, 0%)));
      margin-bottom: calc(var(--desfaseYMovilFrac, var(--desfaseYFrac, 0)) * var(--ratio, 0.5625) * 100%);
    }
    .videoPantallaCompleta {
      min-height: 360px;
    }
    .textoFlotante {
      max-width: min(92%, 50ch) !important;
      font-size: clamp(14px, 2.8vw, 16px) !important;
      padding: 0.6rem 0.8rem;
    }
  }

  @media (max-width: 480px) {
    .videoPantallaCompleta {
      min-height: 280px;
    }
    .textoFlotante {
      max-width: min(95%, 38ch) !important;
      font-size: clamp(13px, 3.6vw, 15px) !important;
      padding: 0.5rem 0.75rem;
    }
  }
{% endstylesheet %}
