{% comment %}
  https://shopify.dev/docs/storefronts/themes/architecture/templates/product
{% endcomment %}
<main class='contenedorProducto'>
  <div class='imagenesProducto'>
    {% if product.images.size > 0 %}
      {% assign imagen_inicial = product.featured_image | default: product.images.first %}
      <div class='galeriaProducto' data-gallery>
        <div class='galeriaThumbs' role='list'>
          {% for img in product.images %}
            <button
              type='button'
              class='galeriaThumb{% if img.id == imagen_inicial.id %} activa{% endif %}'
              data-large='{{ img | image_url: width: 1400 }}'
              aria-label='{{ img.alt | escape | default: product.title }}'
            >
              <img
                src='{{ img | image_url: width: 300, height: 300, crop: "center" }}'
                alt='{{ img.alt | escape | default: product.title }}'
                width='150'
                height='150'
                loading='lazy'
              >
            </button>
          {% endfor %}
        </div>
        <div class='imagenPrincipal'>
          {% assign alto_principal = 1400 | divided_by: imagen_inicial.aspect_ratio | round %}
          <button type='button' class='imagenPrincipalBtn' data-lightbox-trigger>
            <img
              class='imagenPrincipalImg'
              src='{{ imagen_inicial | image_url: width: 1400 }}'
              alt='{{ imagen_inicial.alt | escape | default: product.title }}'
              width='1400'
              height='{{ alto_principal }}'
            >
          </button>
        </div>
      </div>
    {% endif %}
  </div>

  <div class='informacionProducto'>
    <div class='encabezadoProducto'>
      {% assign inventario_restante = 0 %}
      {% assign variantes_controladas = 0 %}
      {% for v in product.variants %}
        {% if v.inventory_management and v.inventory_policy == 'deny' %}
          {% assign inventario_restante = inventario_restante | plus: v.inventory_quantity %}
          {% assign variantes_controladas = variantes_controladas | plus: 1 %}
        {% endif %}
      {% endfor %}
      {% if product.available and variantes_controladas > 0 and inventario_restante > 0 and inventario_restante < 10 %}
        <p class='stock-restante'>
          {% if inventario_restante == 1 %}
            Only 1 left
          {% else %}
            Only {{ inventario_restante }} left
          {% endif %}
        </p>
      {% endif %}

      {% assign coleccion_visible = null %}
      {% for col in product.collections %}
        {% if col.metafields.custom.show_in_related != false %}
          {% assign coleccion_visible = col %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% if coleccion_visible %}
        <a href='{{ coleccion_visible.url }}' class='boton-coleccion'>
          {{ coleccion_visible.title }}
        </a>
      {% endif %}

      {% if product.category != blank %}
        <a href='{{ routes.collections_url }}/{{ product.category | handleize }}' class='boton-categoria'>
          {{ product.category }}
        </a>
      {% endif %}

      <h1 class='tituloProducto'>{{ product.title }}</h1>
      {% assign current_variant = product.selected_or_first_available_variant %}
      <p id='precioProducto'>{{ current_variant.price | money }}</p>
      <p>{{ product.description }}</p>
    </div>

    <div class='acordeones'>
      {% if product.metafields.custom.details %}
        {% assign detalle_html = product.metafields.custom.details | metafield_tag %}
        {% render 'acordeon', title: 'Details', content: detalle_html %}
      {% endif %}

      {% if product.metafields.custom.production_delivery %}
        {% assign mensaje_html = shop.metafields.custom.production_delivery_text | metafield_tag %}
        {% render 'acordeon', title: 'Production & Delivery', content: mensaje_html %}
      {% endif %}
    </div>
    <div class='opcionesProducto'>
      {% form 'product', product %}
        {% assign current_variant = product.selected_or_first_available_variant %}

        <input type='hidden' name='id' id='variantId' value='{{ current_variant.id }}'>

        {% if product.has_only_default_variant == false %}
          {% for option in product.options_with_values %}
            <div class='campoOpcion'>
              {% assign opt_label = option.name %}
              {% assign opt_name_lc = option.name | downcase | strip %}
              {% if opt_name_lc contains 'material' %}
                {% assign opt_label = 'Material' %}
              {% endif %}
              <label class='tituloOpcionCompra' for='opcion-{{ forloop.index }}'>{{ opt_label }}</label>
              <select
                id='opcion-{{ forloop.index }}'
                class='selectPersonalizado'
                data-index='option{{ forloop.index }}'
                aria-label='{{ option.name }}'
              >
                {% for value in option.values %}
                  <option
                    value='{{ value | escape }}'
                    {% if option.selected_value == value %}
                      selected
                    {% endif %}
                  >
                    {{ value }}
                  </option>
                {% endfor %}
              </select>
            </div>
          {% endfor %}
        {% endif %}

        <div class='campoOpcion'>
          <label for='quantity' class='tituloOpcionCompra'>Quantity</label>
          <input id='quantity' type='number' name='quantity' min='1' value='1'>
        </div>

        <input
          type='submit'
          value='{% if current_variant.available %}Add to cart{% else %}Out of Stock{% endif %}'
          {% unless current_variant.available %}
            disabled
          {% endunless %}
        >

        {% if product.metafields.custom.add_chain %}
          {% assign nota = shop.metafields.custom.add_chain | metafield_tag %}
          <div class='textoCadenas'>{{ nota }}</div>
          <input type='button' class='agregarCadenaBtn botonOscuro' data-chain-page='/pages/chains' value='Add Chain'>
        {% endif %}
      {% endform %}

      {% if section.blocks.size > 0 %}
        <div class='enlaces-producto'>
          {% for block in section.blocks %}
            {% case block.type %}
              {% when 'enlace' %}
                {% if block.settings.titulo != blank and block.settings.url != blank %}
                  <a href='{{ block.settings.url }}' class='enlace-producto' {{ block.shopify_attributes }}>
                    {{ block.settings.titulo }}
                  </a>
                {% endif %}
            {% endcase %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</main>

<div class='lightbox' data-lightbox style='display:none;'>
  <button type='button' class='lightbox-close' data-lightbox-close aria-label='Close'>×</button>
  <button type='button' class='lightbox-nav lightbox-nav-prev' data-lightbox-prev aria-label='Previous'>‹</button>
  <button type='button' class='lightbox-nav lightbox-nav-next' data-lightbox-next aria-label='Next'>›</button>
  <div class='lightbox-container'>
    <img
      class='lightbox-img'
      src='about:blank'
      alt=''
      width='1'
      height='1'
      style='max-width:95%;max-height:95vh;width:auto;height:auto;'
    >
  </div>
  <div class='lightbox-counter'><span data-lightbox-current>1</span> / <span data-lightbox-total>1</span></div>
</div>

<div class='modal-cadenas' data-modal-cadenas style='display:none;'>
  <div class='modal-cadenas-contenido'>
    <button type='button' class='modal-cadenas-cerrar' data-modal-cadenas-cerrar aria-label='Cerrar'>×</button>
    <div class='modal-cadenas-body' data-modal-cadenas-body>
      <p style='text-align:center;padding:2rem;'>Cargando...</p>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "t:general.product",
  "settings": [],
  "blocks": [
    {
      "type": "enlace",
      "name": "Enlace a página",
      "settings": [
        {
          "type": "text",
          "id": "titulo",
          "label": "Texto del enlace",
          "default": "Ver más"
        },
        {
          "type": "url",
          "id": "url",
          "label": "URL"
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}

{% stylesheet %}
  .contenedorProducto {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
  }

  #precioProducto {
    font-weight: 600;
    font-size: 1.2rem;
  }

  .textoCadenas {
    margin-top: 0.8rem;
  }

  .agregarCadenaBtn {
    margin-top: -1.5rem;
  }

  .acordeones {
    margin-top: 2rem;
  }

  .imagenesProducto {
    flex: 1 1 70%;
  }

  .galeriaProducto {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .galeriaThumbs {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 70vh;
    scrollbar-width: thin;
  }
  .galeriaThumb {
    border: 2px solid #ddd;
    padding: 0;
    background: transparent;
    cursor: pointer;
    flex-shrink: 0;
    width: 150px;
    height: 150px;
    overflow: hidden;
  }
  .galeriaThumb img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .galeriaThumb.activa {
    border-color: #000;
  }
  .imagenPrincipal {
    flex: 1 1 auto;
  }
  .imagenPrincipalBtn {
    background: transparent;
    border: 0;
    padding: 0;
    cursor: zoom-in;
    display: block;
    width: 100%;
  }
  .imagenPrincipalImg {
    width: 100%;
    height: auto;
    display: block;
    transition: filter 0.3s ease;
  }
  .imagenPrincipalImg.cargando {
    filter: blur(4px);
    opacity: 0.5;
  }

  .lightbox {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.92);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    flex-direction: column;
  }
  .lightbox.activo {
    display: flex;
  }
  .lightbox-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
  }
  .lightbox-img {
    max-width: 90%;
    max-height: 90vh;
    object-fit: contain;
    transition:
      filter 0.3s ease,
      transform 0.5s ease;
  }
  .lightbox-img.blur {
    filter: blur(8px);
    opacity: 0.5;
  }
  .lightbox-img.slide-left {
    animation: slideInFromRight 0.5s ease;
  }
  .lightbox-img.slide-right {
    animation: slideInFromLeft 0.5s ease;
  }
  @keyframes slideInFromLeft {
    from {
      transform: translateX(-100px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  @keyframes slideInFromRight {
    from {
      transform: translateX(100px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  .lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: 0;
    color: #fff;
    font-size: 3rem;
    line-height: 1;
    cursor: pointer;
    padding: 0.5rem;
    opacity: 0.8;
    z-index: 10;
  }
  .lightbox-close:hover {
    opacity: 1;
  }
  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    border: 0;
    color: #fff;
    font-size: 3rem;
    cursor: pointer;
    padding: 1rem;
    opacity: 0.6;
    transition: opacity 0.3s ease;
    z-index: 10;
  }
  .lightbox-nav:hover {
    opacity: 1;
  }
  .lightbox-nav-prev {
    left: 1rem;
  }
  .lightbox-nav-next {
    right: 1rem;
  }
  .lightbox-counter {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
    background: rgba(0, 0, 0, 0.3);
    padding: 0.5rem 1rem;
    border-radius: 20px;
  }
  @media (max-width: 768px) {
    .lightbox {
      padding: 1rem;
    }
    .lightbox-nav {
      font-size: 2rem;
      padding: 0.75rem;
    }
  }

  @media (max-width: 768px) {
    .galeriaProducto {
      flex-direction: column;
    }
    .galeriaThumbs {
      flex-direction: row;
      max-height: none;
    }
    .galeriaThumb img {
      max-width: 64px;
      height: auto;
    }
  }

  .imagenProducto {
    width: 100%;
    height: auto;
  }

  .informacionProducto {
    flex: 1 1 25%;
    font-size: 0.875rem;
  }

  .opcionesProducto {
    margin-top: 1.5rem;
  }

  .opcionesProducto form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .opcionesProducto input,
  .opcionesProducto select {
    width: 100%;
    padding: 0.5rem;
  }

  .opcionesProducto select,
  .opcionesProducto input[type='text'] {
    margin-right: 1rem;
  }

  .opcionesProducto input[type='submit'],
  .opcionesProducto input[type='button'] {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    background-color: #000;
    color: #fff;
    border: none;
    border-radius: 0;
    cursor: pointer;
  }

  .opcionesProducto input[type='submit']:hover,
  .opcionesProducto input[type='button']:hover {
    background-color: #333;
  }
  .stock-restante {
    font-size: 0.9rem;
    text-transform: uppercase;
  }

  .boton-categoria {
    display: block;
    font-size: 0.8rem;
    text-transform: uppercase;
    text-decoration: underline !important;
  }

  .boton-categoria:hover {
    text-decoration: none !important;
  }

  .boton-coleccion {
    display: block;
    font-size: 0.8rem;
    text-transform: uppercase;
    text-decoration: underline !important;
    margin-bottom: 1rem;
  }

  .boton-coleccion:hover {
    text-decoration: none !important;
  }

  .tituloProducto {
    font-size: 1.2rem;
    margin: 0.25rem 0;
  }

  .tituloOpcionCompra {
    font-weight: bold;
    margin-bottom: 0.5rem;
    display: block;
    text-transform: uppercase;
  }

  .enlaces-producto {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
  }

  .enlace-producto {
    display: inline-block;
    font-size: 0.875rem;
    text-decoration: underline;
    color: inherit;
    text-decoration: underline !important;
  }

  .enlace-producto:hover {
    text-decoration: none;
  }

  .modal-cadenas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    overflow: hidden;
  }

  .modal-cadenas-contenido {
    background: #fff;
    width: 100%;
    max-width: 1200px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    padding: 2rem;
    border-radius: 4px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .modal-cadenas-cerrar {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: 0;
    font-size: 2.5rem;
    line-height: 1;
    cursor: pointer;
    padding: 0.5rem;
    z-index: 1;
  }

  .modal-cadenas-cerrar:hover {
    opacity: 0.7;
  }

  .modal-cadenas-body {
    min-height: 200px;
  }

  @media (max-width: 768px) {
    .modal-cadenas-contenido {
      max-height: 95vh;
      padding: 1.5rem 1rem;
    }
  }
{% endstylesheet %}

<script>
  (function(){
    var cont = document.currentScript && document.currentScript.closest ? document.currentScript.closest('.informacionProducto') : document.querySelector('.informacionProducto');
    if (!cont) return;
    var formWrap = cont.querySelector('.opcionesProducto');
    if (!formWrap) return;
    var form = formWrap.querySelector('form');
    if (!form) return;
    var selects = formWrap.querySelectorAll('select[data-index]');
    var idInput = formWrap.querySelector('#variantId');
    if (!idInput) return;
    var variants = {{ product.variants | json }};
    function encontrarVar() {
      var sel = {};
      selects.forEach(function(s){ sel[s.getAttribute('data-index')] = s.value; });
      var v = variants.find(function(x){
        if (sel.option1 && x.option1 !== sel.option1) return false;
        if (sel.option2 && x.option2 !== sel.option2) return false;
        if (sel.option3 && x.option3 !== sel.option3) return false;
        return true;
      });
      return v;
    }
    function actualizar(){
      var v = encontrarVar();
      var submit = formWrap.querySelector("input[type='submit']");
      if (v) {
        idInput.value = v.id;
        if (submit){
          if (v.available) { submit.disabled = false; submit.value = 'Add to cart'; }
          else { submit.disabled = true; submit.value = 'Agotado'; }
        }
        var precio = document.getElementById('precioProducto');
        if (precio) {
          if (typeof Shopify !== 'undefined' && Shopify.formatMoney) {
            try { precio.textContent = Shopify.formatMoney(v.price, "{{ shop.money_format | replace: '"', '\\"' }}"); } catch(e) {}
          } else {
            precio.textContent = (v.price/100).toFixed(2);
          }
        }
        var url = new URL(window.location.href);
        url.searchParams.set('variant', v.id);
        window.history.replaceState({}, '', url);
      }
    }
    selects.forEach(function(s){ s.addEventListener('change', actualizar); });
  })();
</script>

<script>
  (function () {
    function initGaleria(root) {
      root = root || document;
      var galerias = root.querySelectorAll('[data-gallery]');
      galerias.forEach(function (g) {
        if (g.dataset.galInit) return;
        g.dataset.galInit = '1';
        var main = g.querySelector('.imagenPrincipalImg');
        var btns = g.querySelectorAll('.galeriaThumb');
        var lightbox = document.querySelector('[data-lightbox]');
        var lightboxContainer = lightbox ? lightbox.querySelector('.lightbox-container') : null;
        var lightboxImg = lightbox ? lightbox.querySelector('.lightbox-img') : null;
        var trigger = g.querySelector('[data-lightbox-trigger]');
        var closeBtns = lightbox ? lightbox.querySelectorAll('[data-lightbox-close]') : [];
        var prevBtn = lightbox ? lightbox.querySelector('[data-lightbox-prev]') : null;
        var nextBtn = lightbox ? lightbox.querySelector('[data-lightbox-next]') : null;
        var currentCounter = lightbox ? lightbox.querySelector('[data-lightbox-current]') : null;
        var totalCounter = lightbox ? lightbox.querySelector('[data-lightbox-total]') : null;

        var currentImageIndex = 0;
        var allImages = Array.from(btns).map(function (btn) {
          return btn.getAttribute('data-large');
        });

        // Blur effect when changing main image
        btns.forEach(function (btn, index) {
          btn.addEventListener('click', function () {
            var src = btn.getAttribute('data-large');
            if (src && main) {
              main.classList.add('cargando');
              var img = new Image();
              img.onload = function () {
                main.src = src;
                main.classList.remove('cargando');
              };
              img.onerror = function () {
                main.src = src;
                main.classList.remove('cargando');
              };
              img.src = src;

              var active = g.querySelector('.galeriaThumb.activa');
              if (active) active.classList.remove('activa');
              btn.classList.add('activa');
              currentImageIndex = index;
            }
          });
        });

        // Lightbox navigation
        function showImage(index, direction) {
          if (allImages.length === 0) return;

          // Loop infinito
          if (index < 0) index = allImages.length - 1;
          if (index >= allImages.length) index = 0;

          currentImageIndex = index;
          var src = allImages[index];

          if (lightboxImg && src) {
            lightboxImg.classList.remove('slide-left', 'slide-right');
            lightboxImg.classList.add('blur');

            var img = new Image();
            img.onload = function () {
              lightboxImg.src = src;
              lightboxImg.alt = btns[index] ? btns[index].getAttribute('aria-label') : '';
              lightboxImg.removeAttribute('width');
              lightboxImg.removeAttribute('height');

              // Trigger reflow for animation
              void lightboxImg.offsetWidth;

              lightboxImg.classList.remove('blur');
              lightboxImg.classList.add(direction === 'prev' ? 'slide-right' : 'slide-left');

              if (currentCounter) currentCounter.textContent = index + 1;
            };
            img.onerror = function () {
              lightboxImg.src = src;
              lightboxImg.classList.remove('blur');
              lightboxImg.classList.add(direction === 'prev' ? 'slide-right' : 'slide-left');
              if (currentCounter) currentCounter.textContent = index + 1;
            };
            img.src = src;
          }
        }

        if (trigger && lightbox && lightboxImg) {
          // Open lightbox
          trigger.addEventListener('click', function () {
            lightboxImg.src = main.src;
            lightboxImg.alt = main.alt;
            lightboxImg.removeAttribute('width');
            lightboxImg.removeAttribute('height');
            lightbox.style.display = 'flex';
            lightbox.classList.add('activo');
            document.body.style.overflow = 'hidden';

            if (totalCounter) totalCounter.textContent = allImages.length;
            if (currentCounter) currentCounter.textContent = currentImageIndex + 1;
          });

          var cerrarLightbox = function () {
            lightbox.style.display = 'none';
            lightbox.classList.remove('activo');
            document.body.style.overflow = '';
          };

          closeBtns.forEach(function (btn) {
            btn.addEventListener('click', cerrarLightbox);
          });

          lightbox.addEventListener('click', function (e) {
            if (e.target === lightbox) {
              cerrarLightbox();
            }
          });

          // Navigation buttons
          if (prevBtn) {
            prevBtn.addEventListener('click', function () {
              showImage(currentImageIndex - 1, 'prev');
            });
          }
          if (nextBtn) {
            nextBtn.addEventListener('click', function () {
              showImage(currentImageIndex + 1, 'next');
            });
          }

          // Keyboard navigation
          document.addEventListener('keydown', function (e) {
            if (!lightbox.classList.contains('activo')) return;

            if (e.key === 'Escape') {
              cerrarLightbox();
            } else if (e.key === 'ArrowLeft') {
              e.preventDefault();
              showImage(currentImageIndex - 1, 'prev');
            } else if (e.key === 'ArrowRight') {
              e.preventDefault();
              showImage(currentImageIndex + 1, 'next');
            }
          });

          // Touch swipe support
          var touchStartX = 0;
          lightboxContainer.addEventListener('touchstart', function (e) {
            touchStartX = e.touches[0].clientX;
          });
          lightboxContainer.addEventListener('touchend', function (e) {
            var touchEndX = e.changedTouches[0].clientX;
            var diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
              if (diff > 0) {
                showImage(currentImageIndex + 1, 'next');
              } else {
                showImage(currentImageIndex - 1, 'prev');
              }
            }
          });
        }
      });
    }
    document.addEventListener('DOMContentLoaded', function () {
      initGaleria(document);
    });
    document.addEventListener('shopify:section:load', function (e) {
      initGaleria(e.target);
    });
  })();
</script>

<script>
  (function () {
    function initModalCadenas() {
      var modal = document.querySelector('[data-modal-cadenas]');
      var modalBody = modal ? modal.querySelector('[data-modal-cadenas-body]') : null;
      var btnAbrir = document.querySelector('.agregarCadenaBtn');
      var btnsOldCerrar = modal ? modal.querySelectorAll('[data-modal-cadenas-cerrar]') : [];

      if (!modal || !modalBody || !btnAbrir) return;

      var btns = { cerrar: btnsOldCerrar };

      function cerrarModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }

      function abrirModal() {
        var pagina = btnAbrir.getAttribute('data-chain-page');
        if (!pagina) pagina = '/pages/chains';

        modalBody.innerHTML = '<p style="text-align:center;padding:2rem;">Loading...</p>';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        fetch(pagina)
          .then(function (res) {
            return res.text();
          })
          .then(function (html) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');

            var mainEl = doc.querySelector('main');
            if (!mainEl) {
              modalBody.innerHTML = '<p style="text-align:center;padding:2rem;">No content found</p>';
              return;
            }

            modalBody.innerHTML = mainEl.innerHTML;

            var scripts = modalBody.querySelectorAll('script');

            var scriptsExternos = [];
            var scriptsInline = [];

            scripts.forEach(function (oldScript) {
              if (!oldScript.textContent || oldScript.textContent.trim().length === 0) {
                if (oldScript.src) {
                  scriptsExternos.push(oldScript);
                }
                return;
              }
              scriptsInline.push(oldScript);
            });

            var loadedCount = 0;
            function checkAllLoaded() {
              if (loadedCount === scriptsExternos.length) {
                scriptsInline.forEach(function (oldScript) {
                  var codigo = oldScript.textContent;
                  codigo = codigo.replace(
                    /document\.addEventListener\s*\(\s*['"]DOMContentLoaded['"]\s*,\s*function\s*\(\s*\)\s*\{/g,
                    '(function(){'
                  );
                  codigo = codigo.replace(/\}\s*\)\s*;?\s*$/g, '})();');

                  var newScript = document.createElement('script');
                  newScript.textContent = codigo;
                  oldScript.parentNode.replaceChild(newScript, oldScript);
                });
              }
            }

            scriptsExternos.forEach(function (oldScript) {
              var newScript = document.createElement('script');
              newScript.src = oldScript.src;
              newScript.onload = function () {
                loadedCount++;
                checkAllLoaded();
              };
              newScript.onerror = function () {
                loadedCount++;
                checkAllLoaded();
              };
              oldScript.parentNode.replaceChild(newScript, oldScript);
            });

            if (scriptsExternos.length === 0) {
              checkAllLoaded();
            }

            var forms = modalBody.querySelectorAll('form[action*="/cart/add"]');
            forms.forEach(function (form) {
              form.addEventListener('submit', function (e) {
                e.preventDefault();
                var formData = new FormData(form);
                fetch('/cart/add.js', {
                  method: 'POST',
                  body: formData,
                })
                  .then(function (res) {
                    return res.json();
                  })
                  .then(function (data) {
                    if (typeof window.updateCartCount === 'function') {
                      window.updateCartCount();
                    }
                    alert('Chain added to cart!');
                  })
                  .catch(function (err) {
                    alert('Error adding to cart');
                  });
              });
            });
          })
          .catch(function (err) {
            console.error('Error al cargar modal:', err);
            modalBody.innerHTML =
              '<p style="text-align:center;padding:2rem;">Error loading content: ' + err.message + '</p>';
          });
      }

      btnAbrir.addEventListener('click', abrirModal);

      btns.cerrar.forEach(function (btn) {
        btn.addEventListener('click', cerrarModal);
      });

      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          cerrarModal();
        }
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
          cerrarModal();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', initModalCadenas);
    document.addEventListener('shopify:section:load', initModalCadenas);
  })();
</script>
