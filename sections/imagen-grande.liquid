{% if section.settings.imagen_seccion %}
  <div
    class='contenedorImagenGrande full-width'
    style='
      --desfaseY: {{ section.settings.desfase_vertical | default: 0 }}%;
      --desfaseYMovil: {% if section.settings.usar_desfase_escritorio_en_movil %}{{ section.settings.desfase_vertical | default: 0 }}{% else %}{{ section.settings.desfase_vertical_movil | default: 0 }}{% endif %}%;
      --desfaseYFrac: {{ section.settings.desfase_vertical | default: 0 | times: 0.01 }};
      --desfaseYMovilFrac: {% if section.settings.usar_desfase_escritorio_en_movil %}{{ section.settings.desfase_vertical | default: 0 | times: 0.01 }}{% else %}{{ section.settings.desfase_vertical_movil | default: 0 | times: 0.01 }}{% endif %};
      --ratio: calc({{ section.settings.imagen_seccion.height | default: 1 }} / {{ section.settings.imagen_seccion.width | default: 1 }});
      --nivelZ: {{ section.settings.z_index | default: 0 }};
    '
  >
    {% assign url_destino = section.settings.enlace_destino %}

    {% if url_destino != blank %}
      <a class='imagenEnvoltura' href='{{ url_destino }}'>
        {{
          section.settings.imagen_seccion
          | image_url: width: 2000
          | image_tag: alt: section.settings.alt_texto
          | default: section.settings.imagen_seccion.alt
        }}
        {% assign hay_texto = section.settings.texto_seccion %}
        {% assign hay_boton = section.settings.enlace_boton %}
        {% if hay_texto != blank or hay_boton != blank %}
          <div
            class='textoFlotante {% case section.settings.posicion_texto | default: 'centro' %}{% when 'centro' %}posCentro{% when 'supIzq' %}posSupIzq{% when 'supDer' %}posSupDer{% when 'infIzq' %}posInfIzq{% when 'infDer' %}posInfDer{% when 'supCentro' %}posSupCentro{% when 'infCentro' %}posInfCentro{% when 'centroDer' %}posCentroDer{% when 'centroIzq' %}posCentroIzq{% endcase %}'
            style='
              color: {{ section.settings.color_texto | default: "#ffffff" }};
              {% if section.settings.mostrar_fondo %} background: {{ section.settings.color_fondo | default: "rgba(0,0,0,0.5)" }}; {% else %} background: transparent; {% endif %}
              max-width: {% if section.settings.max_ancho_ch %}{{ section.settings.max_ancho_ch }}ch{% else %}60ch{% endif %};
              font-size: {% if section.settings.tamano_fuente %}{{ section.settings.tamano_fuente }}px{% else %}18px{% endif %};
              text-align: {{ section.settings.alineacion_texto | default: 'center' }};
              {% assign offx = section.settings.offset_x | default: 16 %}
              {% assign offy = section.settings.offset_y | default: 16 %}
              {% assign unidad = section.settings.unidad_offset | default: 'px' %}
              {% case section.settings.posicion_texto | default: 'centro' %}
                {% when 'supIzq' %} top: {{ offy }}{{ unidad }}; left: {{ offx }}{{ unidad }}; transform: none;
                {% when 'supDer' %} top: {{ offy }}{{ unidad }}; right: {{ offx }}{{ unidad }}; transform: none;
                {% when 'infIzq' %} bottom: {{ offy }}{{ unidad }}; left: {{ offx }}{{ unidad }}; transform: none;
                {% when 'infDer' %} bottom: {{ offy }}{{ unidad }}; right: {{ offx }}{{ unidad }}; transform: none;
                {% when 'supCentro' %} top: {{ offy }}{{ unidad }}; left: 50%; transform: translateX(-50%);
                {% when 'infCentro' %} bottom: {{ offy }}{{ unidad }}; left: 50%; transform: translateX(-50%);
                {% when 'centroDer' %} top: 50%; right: {{ offx }}{{ unidad }}; transform: translateY(-50%);
                {% when 'centroIzq' %} top: 50%; left: {{ offx }}{{ unidad }}; transform: translateY(-50%);
                {% else %} top: 50%; left: 50%; transform: translate(-50%, -50%);
              {% endcase %}
            '
          >
            {% if section.settings.texto_seccion != blank %}
              {{ section.settings.texto_seccion }}
            {% endif %}
            {% if section.settings.enlace_boton != blank %}
              <div class='enlaceImagen botonDestacado'>
                <a href='{{ section.settings.enlace_boton }}' class='imagenBoton'>
                  {{ section.settings.texto_boton | default: 'Ver más' }}
                </a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </a>
    {% else %}
      <div class='imagenEnvoltura'>
        {{
          section.settings.imagen_seccion
          | image_url: width: 2000
          | image_tag: alt: section.settings.alt_texto
          | default: section.settings.imagen_seccion.alt
        }}
        {% assign hay_texto = section.settings.texto_seccion %}
        {% assign hay_boton = section.settings.enlace_boton %}
        {% if hay_texto != blank or hay_boton != blank %}
          <div
            class='textoFlotante {% case section.settings.posicion_texto | default: 'centro' %}{% when 'centro' %}posCentro{% when 'supIzq' %}posSupIzq{% when 'supDer' %}posSupDer{% when 'infIzq' %}posInfIzq{% when 'infDer' %}posInfDer{% when 'supCentro' %}posSupCentro{% when 'infCentro' %}posInfCentro{% when 'centroDer' %}posCentroDer{% when 'centroIzq' %}posCentroIzq{% endcase %}'
            style='
              {% if section.settings.mostrar_fondo %} background: {{ section.settings.color_fondo | default: "rgba(0,0,0,0.5)" }}; {% else %} background: transparent; {% endif %}
              max-width: {% if section.settings.max_ancho_ch %}{{ section.settings.max_ancho_ch }}ch{% else %}60ch{% endif %};
              font-size: {% if section.settings.tamano_fuente %}{{ section.settings.tamano_fuente }}px{% else %}18px{% endif %};
              text-align: {{ section.settings.alineacion_texto | default: 'center' }};
              {% assign offx = section.settings.offset_x | default: 16 %}
              {% assign offy = section.settings.offset_y | default: 16 %}
              {% assign unidad = section.settings.unidad_offset | default: 'px' %}
              {% case section.settings.posicion_texto | default: 'centro' %}
                {% when 'supIzq' %} top: {{ offy }}{{ unidad }}; left: {{ offx }}{{ unidad }}; transform: none;
                {% when 'supDer' %} top: {{ offy }}{{ unidad }}; right: {{ offx }}{{ unidad }}; transform: none;
                {% when 'infIzq' %} bottom: {{ offy }}{{ unidad }}; left: {{ offx }}{{ unidad }}; transform: none;
                {% when 'infDer' %} bottom: {{ offy }}{{ unidad }}; right: {{ offx }}{{ unidad }}; transform: none;
                {% when 'supCentro' %} top: {{ offy }}{{ unidad }}; left: 50%; transform: translateX(-50%);
                {% when 'infCentro' %} bottom: {{ offy }}{{ unidad }}; left: 50%; transform: translateX(-50%);
                {% when 'centroDer' %} top: 50%; right: {{ offx }}{{ unidad }}; transform: translateY(-50%);
                {% when 'centroIzq' %} top: 50%; left: {{ offx }}{{ unidad }}; transform: translateY(-50%);
                {% else %} top: 50%; left: 50%; transform: translate(-50%, -50%);
              {% endcase %}
            '
          >
            {% if section.settings.texto_seccion != blank %}
              {{ section.settings.texto_seccion }}
            {% endif %}
            {% if section.settings.enlace_boton != blank %}
              <div class='enlaceImagen botonDestacado'>
                <a href='{{ section.settings.enlace_boton }}' class='imagenBoton'>
                  {{ section.settings.texto_boton | default: 'Ver más' }}
                </a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endif %}

{% schema %}
{
  "name": "Imágen grande",
  "settings": [
    {
      "type": "image_picker",
      "id": "imagen_seccion",
      "label": "Archivo de imagen"
    },
    {
      "type": "text",
      "id": "alt_texto",
      "label": "Texto alternativo (accesibilidad)",
      "info": "Si se deja vacío, se usa el alt de la imagen."
    },
    {
      "type": "richtext",
      "id": "texto_seccion",
      "label": "Texto sobre imagen"
    },
    {
      "type": "select",
      "id": "posicion_texto",
      "label": "Posición del texto",
      "default": "centro",
      "options": [
        { "value": "centro", "label": "Centrado" },
        { "value": "centroDer", "label": "Centro derecha" },
        { "value": "centroIzq", "label": "Centro izquierda" },
        { "value": "supCentro", "label": "Superior centro" },
        { "value": "supDer", "label": "Superior derecha" },
        { "value": "supIzq", "label": "Superior izquierda" },
        { "value": "infCentro", "label": "Inferior centro" },
        { "value": "infDer", "label": "Inferior derecha" },
        { "value": "infIzq", "label": "Inferior izquierda" }
      ]
    },
    {
      "type": "select",
      "id": "alineacion_texto",
      "label": "Alineación del texto",
      "default": "center",
      "options": [
        { "value": "left", "label": "Izquierda" },
        { "value": "center", "label": "Centro" },
        { "value": "right", "label": "Derecha" }
      ]
    },
    {
      "type": "url",
      "id": "enlace_destino",
      "label": "Enlace (opcional)",
      "info": "Si estableces un enlace, toda la imagen será clicable como un gran botón. Recomendación: evita incluir enlaces dentro del texto superpuesto para no anidar enlaces."
    },
    {
      "type": "paragraph",
      "content": "Consejos de accesibilidad: usa un texto alternativo (alt) descriptivo si la imagen comunica información, o déjalo vacío si es decorativa."
    },
    {
      "type": "color",
      "id": "color_texto",
      "label": "Color del texto (opcional)",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "color_fondo",
      "label": "Color de fondo del overlay (opcional)",
      "default": "rgba(0,0,0,0.5)"
    },
    {
      "type": "checkbox",
      "id": "mostrar_fondo",
      "label": "Mostrar fondo detrás del texto",
      "default": true
    },
    {
      "type": "range",
      "id": "max_ancho_ch",
      "label": "Ancho máximo del texto (ch)",
      "min": 20,
      "max": 80,
      "step": 1,
      "default": 60
    },
    {
      "type": "select",
      "id": "unidad_offset",
      "label": "Unidad de separación (px o %)",
      "default": "px",
      "options": [
        { "value": "px", "label": "Pixeles (px)" },
        { "value": "%", "label": "Porcentaje (%)" }
      ],
      "info": "Define la unidad para las separaciones horizontal/vertical del texto superpuesto."
    },
    {
      "type": "range",
      "id": "offset_x",
      "label": "Separación horizontal",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 16,
      "info": "Usa la unidad seleccionada arriba (px o %)."
    },
    {
      "type": "range",
      "id": "offset_y",
      "label": "Separación vertical",
      "min": 0,
      "max": 100,
      "step": 1,
      "default": 16,
      "info": "Usa la unidad seleccionada arriba (px o %)."
    },
    {
      "type": "range",
      "id": "tamano_fuente",
      "label": "Tamaño de fuente (px)",
      "min": 12,
      "max": 48,
      "step": 1,
      "default": 18
    },
    {
      "type": "text",
      "id": "texto_boton",
      "label": "Texto del botón",
      "default": "Ver más"
    },
    {
      "type": "url",
      "id": "enlace_boton",
      "label": "Enlace del botón"
    },
    {
      "type": "header",
      "content": "Desplazamiento y niveles"
    },
    {
      "type": "paragraph",
      "content": "En móvil puedes heredar el desfase de escritorio (opción recomendada) o personalizarlo. El z-index controla el apilado entre secciones; valores más altos quedan por encima."
    },
    {
      "type": "checkbox",
      "id": "usar_desfase_escritorio_en_movil",
      "label": "Usar el desfase de escritorio en móvil",
      "default": true
    },
    {
      "type": "range",
      "id": "desfase_vertical",
      "label": "Desfase vertical (%)",
      "min": -50,
      "max": 50,
      "step": 1,
      "default": 0,
      "info": "Desplaza la sección en porcentaje relativo a su altura. Negativo: sube; Positivo: baja."
    },
    {
      "type": "range",
      "id": "desfase_vertical_movil",
      "label": "Desfase vertical en móvil (%)",
      "min": -50,
      "max": 50,
      "step": 1,
      "default": 0,
      "info": "Valor específico para pantallas pequeñas (≤768px). Si activas \"Usar el desfase de escritorio en móvil\", este valor se ignora."
    },
    {
      "type": "range",
      "id": "z_index",
      "label": "Nivel (z-index)",
      "min": -5,
      "max": 20,
      "step": 1,
      "default": 0,
      "info": "Controla si esta sección queda por encima o por debajo de las vecinas cuando se solapan. Si no ves efecto, revisa si un contenedor padre crea un nuevo contexto de apilado (por ejemplo, con transform u opacity)."
    }
  ],
  "presets": [
    {
      "name": "Imágen grande",
      "category": "Decoraciones"
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .contenedorImagenGrande {
    position: relative;
    transform: translateY(var(--desfaseY, 0%));
    will-change: transform;
    z-index: var(--nivelZ, 0);
    margin-bottom: calc(var(--desfaseYFrac, 0) * var(--ratio, 0) * 100%);
  }

  .imagenEnvoltura {
    display: block;
    position: relative;
    text-decoration: none;
    color: inherit;
  }

  .imagenEnvoltura img {
    display: block;
    width: 100%;
    height: auto;
  }

  .textoFlotante {
    position: absolute;
    max-width: min(90%, 60ch);
    color: #fff;
    background: rgba(0, 0, 0, 0.5);
    padding: 0.75rem 1rem;
  }

  .textoFlotante.posCentro {
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
  }
  .textoFlotante.posSupIzq {
    top: 1rem;
    left: 1rem;
  }
  .textoFlotante.posSupDer {
    top: 1rem;
    right: 1rem;
  }
  .textoFlotante.posSupCentro {
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
  }
  .textoFlotante.posInfCentro {
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
  }
  .textoFlotante.posCentroDer {
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    text-align: right;
  }
  .textoFlotante.posCentroIzq {
    top: 50%;
    left: 1rem;
    transform: translateY(-50%);
    text-align: left;
  }
  .textoFlotante.posInfIzq {
    bottom: 1rem;
    left: 1rem;
  }
  .textoFlotante.posInfDer {
    bottom: 1rem;
    right: 1rem;
  }

  .enlaceImagen {
    margin-top: 1em;
  }
  @media (max-width: 768px) {
    .contenedorImagenGrande {
      transform: translateY(var(--desfaseYMovil, var(--desfaseY, 0%)));
      margin-bottom: calc(var(--desfaseYMovilFrac, var(--desfaseYFrac, 0)) * var(--ratio, 0) * 100%);
    }
    .textoFlotante {
      max-width: min(92%, 50ch) !important;
      font-size: clamp(14px, 2.8vw, 16px) !important;
      padding: 0.6rem 0.8rem;
    }
  }
  @media (max-width: 480px) {
    .textoFlotante {
      max-width: min(95%, 38ch) !important;
      font-size: clamp(13px, 3.6vw, 15px) !important;
      padding: 0.5rem 0.75rem;
    }
  }
{% endstylesheet %}
