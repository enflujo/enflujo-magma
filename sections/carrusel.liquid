{% comment %}
  Sección de carrusel para mostrar productos o colecciones
{% endcomment %}

{% assign ancho_completo = section.settings.ancho_completo | default: false %}
{% assign ratio = section.settings.ratio | default: '1:1' %}
{% assign gap_carrusel = section.settings.gap_carrusel | default: 12 %}
{% assign altura_desktop = section.settings.altura_desktop | default: 300 %}
{% assign altura_mobile = section.settings.altura_mobile | default: 200 %}
{% comment %} Estilos disponibles: collage (image-only), simple (image + info) {% endcomment %}
{% assign estilo_vista = 'collage' %}

{% comment %} Convertir ratio a CSS aspect-ratio {% endcomment %}
{% if ratio == '1:1' %}
  {% assign ratio_css = '1 / 1' %}
{% elsif ratio == '4:3' %}
  {% assign ratio_css = '4 / 3' %}
{% elsif ratio == '3:2' %}
  {% assign ratio_css = '3 / 2' %}
{% elsif ratio == '16:9' %}
  {% assign ratio_css = '16 / 9' %}
{% elsif ratio == '2:3' %}
  {% assign ratio_css = '2 / 3' %}
{% elsif ratio == '3:4' %}
  {% assign ratio_css = '3 / 4' %}
{% elsif ratio == '9:16' %}
  {% assign ratio_css = '9 / 16' %}
{% else %}
  {% assign ratio_css = '1 / 1' %}
{% endif %}

<div
  class='contenedorCarrusel{% if ancho_completo %} contenedorCarrusel--completo{% endif %}'
  {% if section.settings.anchor_seccion != blank %}
    id='{{ section.settings.anchor_seccion }}'
  {% endif %}
  data-carrusel-container
>
  {% if section.settings.titulo != blank %}
    <h2 class='tituloCarrusel'>{{ section.settings.titulo }}</h2>
  {% endif %}

  <div class='carruselWrapper'>
    <button class='carruselNav carruselNav--prev' data-carrusel-prev aria-label='Previous' style='display: none;'>
      ‹
    </button>

    <div
      class='carrusel carrusel--{{ estilo_vista }}'
      data-carrusel
      style='gap: {{ gap_carrusel }}px; --carrusel-ratio: {{ ratio_css }}; --altura-desktop: {{ altura_desktop }}px; --altura-mobile: {{ altura_mobile }}px;'
    >
      {% if section.settings.tipo == 'productos' %}
        {% if section.settings.modo == 'manual' %}
          {% comment %} Modo manual: mostrar bloques seleccionados {% endcomment %}
          {% for block in section.blocks %}
            {% if block.type == 'producto' %}
              {% assign prod = all_products[block.settings.producto] %}
              {% if prod %}
                <div class='carruselItemWrapper'>
                  <a href='{{ prod.url }}' class='carruselItem carruselItem--link'>
                    {% if prod.images.size > 0 %}
                      {% render 'mini-collage-auto', images: prod.images, ratio: ratio %}
                    {% else %}
                      {% render 'tarjeta-collage', item: prod, tipo: 'producto', estilo: estilo_vista, ratio: ratio %}
                    {% endif %}
                  </a>
                  {% if prod.title %}
                    <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
                  {% endif %}
                </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        {% else %}
          {% comment %} Modo automático: productos relacionados {% endcomment %}
          {% assign producto_actual = product %}
          {% assign ids_mostrados = '' %}

          {% comment %} 1. Primero buscar en la misma colección {% endcomment %}
          {% if producto_actual.collections.first %}
            {% assign coleccion_principal = producto_actual.collections.first %}
            {% for prod in coleccion_principal.products %}
              {% if prod.id != producto_actual.id %}
                <div class='carruselItemWrapper'>
                  <a href='{{ prod.url }}' class='carruselItem carruselItem--link'>
                    {% if prod.images.size > 0 %}
                      {% render 'mini-collage-auto', images: prod.images, ratio: ratio %}
                    {% else %}
                      {% render 'tarjeta-collage', item: prod, tipo: 'producto', estilo: estilo_vista, ratio: ratio %}
                    {% endif %}
                  </a>
                  {% if prod.title %}
                    <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
                  {% endif %}
                </div>
                {% assign ids_mostrados = ids_mostrados | append: prod.id | append: ',' %}
              {% endif %}
            {% endfor %}
          {% endif %}

          {% comment %} 2. Complementar con productos que comparten tags {% endcomment %}
          {% if producto_actual.tags.size > 0 %}
            {% for prod in collections.all.products limit: 100 %}
              {% if prod.id != producto_actual.id %}
                {% assign id_str = prod.id | append: ',' %}
                {% unless ids_mostrados contains id_str %}
                  {% assign tiene_tag_comun = false %}
                  {% for tag in prod.tags %}
                    {% if producto_actual.tags contains tag %}
                      {% assign tiene_tag_comun = true %}
                      {% break %}
                    {% endif %}
                  {% endfor %}

                  {% if tiene_tag_comun %}
                    <div class='carruselItemWrapper'>
                      <a href='{{ prod.url }}' class='carruselItem carruselItem--link'>
                        {% if prod.images.size > 0 %}
                          {% render 'mini-collage-auto', images: prod.images, ratio: ratio %}
                        {% else %}
                          {% render 'tarjeta-collage',
                            item: prod,
                            tipo: 'producto',
                            estilo: estilo_vista,
                            ratio: ratio
                          %}
                        {% endif %}
                      </a>
                      {% if prod.title %}
                        <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
                      {% endif %}
                    </div>
                    {% assign ids_mostrados = ids_mostrados | append: prod.id | append: ',' %}
                  {% endif %}
                {% endunless %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}

      {% elsif section.settings.tipo == 'colecciones' %}
        {% if section.settings.modo == 'manual' %}
          {% for block in section.blocks %}
            {% if block.type == 'coleccion' %}
              {% assign col = collections[block.settings.coleccion] %}
              {% if col %}
                <div class='carruselItemWrapper'>
                  <a href='{{ col.url }}' class='carruselItem carruselItem--link'>
                    {% render 'tarjeta-collage', item: col, tipo: 'coleccion', estilo: estilo_vista, ratio: ratio %}
                  </a>
                  {% if col.title %}
                    <h3 class='carruselItemTitulo'>{{ col.title }}</h3>
                  {% endif %}
                </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endif %}
    </div>

    <button class='carruselNav carruselNav--next' data-carrusel-next aria-label='Next' style='display: none;'>›</button>
  </div>
</div>

{% schema %}
{
  "name": "Carrusel",
  "settings": [
    {
      "type": "text",
      "id": "anchor_seccion",
      "label": "ID de ancla (opcional)",
      "info": "Define un ID para esta sección (ej: jewelry, prints). Permite navegación directa desde el menú de íconos.",
      "placeholder": "jewelry"
    },
    {
      "type": "text",
      "id": "titulo",
      "label": "Título",
      "default": "Productos relacionados"
    },
    {
      "type": "select",
      "id": "tipo",
      "label": "Tipo de contenido",
      "default": "productos",
      "options": [
        { "value": "productos", "label": "Productos" },
        { "value": "colecciones", "label": "Colecciones" }
      ]
    },
    {
      "type": "select",
      "id": "modo",
      "label": "Modo de selección",
      "default": "automatico",
      "info": "Automático: productos relacionados. Manual: selecciona bloques específicos.",
      "options": [
        { "value": "automatico", "label": "Automático (relacionados)" },
        { "value": "manual", "label": "Manual (bloques)" }
      ]
    },
    {
      "type": "range",
      "id": "gap_carrusel",
      "label": "Separación entre items (px)",
      "min": 0,
      "max": 500,
      "step": 1,
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "ancho_completo",
      "label": "Ancho completo de pantalla",
      "default": false,
      "info": "Si está desactivado, usa el ancho del contenido"
    },
    {
      "type": "select",
      "id": "ratio",
      "label": "Relación de aspecto",
      "default": "1:1",
      "options": [
        { "value": "1:1", "label": "1:1" },
        { "value": "4:3", "label": "4:3" },
        { "value": "3:2", "label": "3:2" },
        { "value": "16:9", "label": "16:9" },
        { "value": "2:3", "label": "2:3 (vertical)" },
        { "value": "3:4", "label": "3:4 (vertical)" },
        { "value": "9:16", "label": "9:16 (vertical)" }
      ]
    },
    {
      "type": "range",
      "id": "altura_desktop",
      "label": "Alto del carrusel en desktop (px)",
      "min": 150,
      "max": 600,
      "step": 10,
      "default": 300
    },
    {
      "type": "range",
      "id": "altura_mobile",
      "label": "Alto del carrusel en móvil (px)",
      "min": 100,
      "max": 400,
      "step": 10,
      "default": 200
    }
  ],
  "blocks": [
    {
      "type": "producto",
      "name": "Producto",
      "settings": [
        {
          "type": "product",
          "id": "producto",
          "label": "Seleccionar producto"
        }
      ]
    },
    {
      "type": "coleccion",
      "name": "Colección",
      "settings": [
        {
          "type": "collection",
          "id": "coleccion",
          "label": "Seleccionar colección"
        }
      ]
    },
    {
      "type": "mini_collage",
      "name": "Mini-collage",
      "settings": [
        {
          "type": "select",
          "id": "layout",
          "label": "Diseño",
          "default": "cuatro",
          "options": [
            { "value": "cuatro", "label": "4 imágenes iguales" },
            { "value": "tres_izq_grande", "label": "3 con grande a la izquierda" },
            { "value": "tres_der_grande", "label": "3 con grande a la derecha" },
            { "value": "dos", "label": "2 iguales" },
            { "value": "cinco_T", "label": "5 en T" },
            { "value": "seis", "label": "6 (3x2)" },
            { "value": "seis_grande", "label": "6 con una grande" }
          ]
        },
        {
          "type": "text",
          "id": "titulo",
          "label": "Título (opcional)",
          "info": "Texto que se mostrará debajo del mini-collage"
        },
        {
          "type": "url",
          "id": "enlace",
          "label": "Enlace (opcional)",
          "info": "URL a producto, colección o página"
        },
        { "type": "image_picker", "id": "img1", "label": "Imagen 1" },
        { "type": "text", "id": "alt1", "label": "Alt 1 (opcional)" },
        { "type": "image_picker", "id": "img2", "label": "Imagen 2" },
        { "type": "text", "id": "alt2", "label": "Alt 2 (opcional)" },
        { "type": "image_picker", "id": "img3", "label": "Imagen 3" },
        { "type": "text", "id": "alt3", "label": "Alt 3 (opcional)" },
        { "type": "image_picker", "id": "img4", "label": "Imagen 4" },
        { "type": "text", "id": "alt4", "label": "Alt 4 (opcional)" },
        { "type": "image_picker", "id": "img5", "label": "Imagen 5" },
        { "type": "text", "id": "alt5", "label": "Alt 5 (opcional)" },
        { "type": "image_picker", "id": "img6", "label": "Imagen 6" },
        { "type": "text", "id": "alt6", "label": "Alt 6 (opcional)" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Carrusel"
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .contenedorCarrusel {
    padding: 2rem 0;
  }

  .contenedorCarrusel--completo {
    max-width: 100vw;
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
  }

  .tituloCarrusel {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
  }

  .carruselWrapper {
    position: relative;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .carrusel {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 0 1rem 1rem;
    flex: 1 1 auto;
  }

  /* Ocultar scrollbar completamente */
  .carrusel::-webkit-scrollbar {
    display: none;
  }

  .carruselNav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.7);
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    opacity: 0.8;
    transition: opacity 0.3s ease;
    z-index: 10;
    line-height: 1;
  }

  .carruselNav:hover {
    opacity: 1;
  }

  .carruselNav--prev {
    left: 0;
  }

  .carruselNav--next {
    right: 0;
  }

  .carruselItemWrapper {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    scroll-snap-align: start;
    height: var(--altura-desktop, 300px);
    aspect-ratio: var(--carrusel-ratio, 1 / 1);
    gap: 0.5rem;
  }

  .carruselItem {
    display: block;
    width: 100%;
    height: 100%;
    overflow: hidden;
    object-fit: cover;
  }

  .carruselItem--link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .carruselItemTitulo {
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
    margin: 0.5rem 0 0 0;
    padding: 0;
    flex-shrink: 0;
  }

  @media (max-width: 768px) {
    .carruselNav {
      font-size: 1.5rem;
      padding: 0.35rem 0.5rem;
    }

    .carruselItemWrapper {
      height: var(--altura-mobile, 200px);
    }
  }
{% endstylesheet %}

<script>
  (function () {
    function initCarrusel(root) {
      root = root || document;
      var containers = root.querySelectorAll('[data-carrusel-container]');

      containers.forEach(function (container) {
        var carousel = container.querySelector('[data-carrusel]');
        var prevBtn = container.querySelector('[data-carrusel-prev]');
        var nextBtn = container.querySelector('[data-carrusel-next]');

        if (!carousel || !prevBtn || !nextBtn) return;

        // Detectar si hay overflow
        function checkOverflow() {
          var hasScroll = carousel.scrollWidth > carousel.clientWidth;
          prevBtn.style.display = hasScroll ? 'block' : 'none';
          nextBtn.style.display = hasScroll ? 'block' : 'none';
        }

        // Navegar con botones
        function scroll(direction) {
          var itemWidth = carousel.querySelector('.carruselItem')
            ? carousel.querySelector('.carruselItem').offsetWidth
            : 200;
          var gap = 24; // 1.5rem = 24px
          var scrollAmount = itemWidth + gap;

          if (direction === 'prev') {
            carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
          } else {
            carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
          }
        }

        prevBtn.addEventListener('click', function () {
          scroll('prev');
        });

        nextBtn.addEventListener('click', function () {
          scroll('next');
        });

        // Swipe support
        var touchStartX = 0;
        carousel.addEventListener('touchstart', function (e) {
          touchStartX = e.touches[0].clientX;
        });

        carousel.addEventListener('touchend', function (e) {
          var touchEndX = e.changedTouches[0].clientX;
          var diff = touchStartX - touchEndX;

          if (Math.abs(diff) > 50) {
            if (diff > 0) {
              scroll('next');
            } else {
              scroll('prev');
            }
          }
        });

        // Check overflow on load and resize
        checkOverflow();
        window.addEventListener('resize', function () {
          checkOverflow();
        });

        // Observe for dynamic content changes
        if (window.ResizeObserver) {
          var observer = new ResizeObserver(function () {
            checkOverflow();
          });
          observer.observe(carousel);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      initCarrusel(document);
    });

    document.addEventListener('shopify:section:load', function (e) {
      initCarrusel(e.target);
    });
  })();
</script>
