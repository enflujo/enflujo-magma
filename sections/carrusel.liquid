{% comment %}
  Sección de carrusel para mostrar productos o colecciones
{% endcomment %}

<div class='contenedorCarrusel'>
  {% if section.settings.titulo != blank %}
    <h2 class='tituloCarrusel'>{{ section.settings.titulo }}</h2>
  {% endif %}

  <div class='carrusel' data-carrusel>
    {% if section.settings.tipo == 'productos' %}
      {% comment %} Modo manual: usar bloques {% endcomment %}
      {% if section.settings.modo == 'manual' %}
        {% for block in section.blocks %}
          {% if block.type == 'producto' %}
            {% assign prod = all_products[block.settings.producto] %}
            {% if prod %}
              <a href='{{ prod.url }}' class='carruselItem'>
                {% if prod.featured_image %}
                  <img
                    src='{{ prod.featured_image | image_url: width: 400, height: 400, crop: "center" }}'
                    alt='{{ prod.title }}'
                    width='200'
                    height='200'
                    loading='lazy'
                  >
                {% endif %}
                <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
                <p class='carruselItemPrecio'>{{ prod.price | money }}</p>
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% else %}
        {% comment %} Modo automático: productos relacionados {% endcomment %}
        {% assign max_productos = section.settings.limite | default: 8 %}
        {% assign producto_actual = product %}
        {% assign contador = 0 %}
        {% assign ids_mostrados = '' %}

        {% comment %} 1. Primero buscar en la misma colección {% endcomment %}
        {% if producto_actual.collections.first %}
          {% assign coleccion_principal = producto_actual.collections.first %}
          {% for prod in coleccion_principal.products limit: 20 %}
            {% if prod.id != producto_actual.id and contador < max_productos %}
              <a href='{{ prod.url }}' class='carruselItem'>
                {% if prod.featured_image %}
                  <img
                    src='{{ prod.featured_image | image_url: width: 400, height: 400, crop: "center" }}'
                    alt='{{ prod.title }}'
                    width='200'
                    height='200'
                    loading='lazy'
                  >
                {% endif %}
                <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
                <p class='carruselItemPrecio'>{{ prod.price | money }}</p>
              </a>
              {% assign contador = contador | plus: 1 %}
              {% assign ids_mostrados = ids_mostrados | append: prod.id | append: ',' %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% comment %} 2. Si no hay suficientes, completar con productos que comparten tags {% endcomment %}
        {% if contador < max_productos and producto_actual.tags.size > 0 %}
          {% for prod in collections.all.products limit: 50 %}
            {% if prod.id != producto_actual.id and contador < max_productos %}
              {% assign id_str = prod.id | append: ',' %}
              {% unless ids_mostrados contains id_str %}
                {% assign tiene_tag_comun = false %}
                {% for tag in prod.tags %}
                  {% if producto_actual.tags contains tag %}
                    {% assign tiene_tag_comun = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}

                {% if tiene_tag_comun %}
                  <a href='{{ prod.url }}' class='carruselItem'>
                    {% if prod.featured_image %}
                      <img
                        src='{{ prod.featured_image | image_url: width: 400, height: 400, crop: "center" }}'
                        alt='{{ prod.title }}'
                        width='200'
                        height='200'
                        loading='lazy'
                      >
                    {% endif %}
                    <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
                    <p class='carruselItemPrecio'>{{ prod.price | money }}</p>
                  </a>
                  {% assign contador = contador | plus: 1 %}
                  {% assign ids_mostrados = ids_mostrados | append: prod.id | append: ',' %}
                {% endif %}
              {% endunless %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endif %}

    {% elsif section.settings.tipo == 'colecciones' %}
      {% for block in section.blocks %}
        {% if block.type == 'coleccion' %}
          {% assign col = collections[block.settings.coleccion] %}
          {% if col %}
            <a href='{{ col.url }}' class='carruselItem'>
              {% if col.featured_image %}
                <img
                  src='{{ col.featured_image | image_url: width: 400, height: 400, crop: "center" }}'
                  alt='{{ col.title }}'
                  width='200'
                  height='200'
                  loading='lazy'
                >
              {% elsif col.products.first.featured_image %}
                <img
                  src='{{ col.products.first.featured_image | image_url: width: 400, height: 400, crop: "center" }}'
                  alt='{{ col.title }}'
                  width='200'
                  height='200'
                  loading='lazy'
                >
              {% endif %}
              <h3 class='carruselItemTitulo'>{{ col.title }}</h3>
              <p class='carruselItemCantidad'>{{ col.products_count }} productos</p>
            </a>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Carrusel",
  "settings": [
    {
      "type": "text",
      "id": "titulo",
      "label": "Título",
      "default": "Productos relacionados"
    },
    {
      "type": "select",
      "id": "tipo",
      "label": "Tipo de contenido",
      "default": "productos",
      "options": [
        { "value": "productos", "label": "Productos" },
        { "value": "colecciones", "label": "Colecciones" }
      ]
    },
    {
      "type": "select",
      "id": "modo",
      "label": "Modo de selección",
      "default": "automatico",
      "info": "Automático: muestra productos relacionados de la misma colección o con tags similares. Manual: selecciona productos específicos.",
      "options": [
        { "value": "automatico", "label": "Automático (relacionados)" },
        { "value": "manual", "label": "Manual (bloques)" }
      ]
    },
    {
      "type": "range",
      "id": "limite",
      "label": "Cantidad máxima de productos (modo automático)",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 8
    }
  ],
  "blocks": [
    {
      "type": "producto",
      "name": "Producto",
      "settings": [
        {
          "type": "product",
          "id": "producto",
          "label": "Seleccionar producto"
        }
      ]
    },
    {
      "type": "coleccion",
      "name": "Colección",
      "settings": [
        {
          "type": "collection",
          "id": "coleccion",
          "label": "Seleccionar colección"
        }
      ]
    }
  ],
  "max_blocks": 20,
  "presets": [
    {
      "name": "Carrusel"
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .contenedorCarrusel {
    padding: 2rem 0;
  }

  .tituloCarrusel {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
  }

  .carrusel {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    padding: 0 1rem 1rem;
  }

  .carruselItem {
    flex: 0 0 200px;
    scroll-snap-align: start;
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: transform 0.2s ease;
  }

  .carruselItem:hover {
    transform: translateY(-4px);
  }

  .carruselItem img {
    width: 100%;
    height: auto;
    border: 1px solid #eee;
    display: block;
  }

  .carruselItemTitulo {
    font-size: 0.9rem;
    margin: 0;
    font-weight: 600;
  }

  .carruselItemPrecio,
  .carruselItemCantidad {
    font-size: 0.85rem;
    margin: 0;
    color: #666;
  }

  @media (max-width: 768px) {
    .carruselItem {
      flex: 0 0 160px;
    }
  }
{% endstylesheet %}
