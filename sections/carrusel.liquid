{% comment %}
  Sección de carrusel para mostrar productos o colecciones
{% endcomment %}

{% assign ancho_completo = section.settings.ancho_completo | default: false %}
{% assign estilo_vista = section.settings.estilo_vista | default: 'simple' %}
{% assign ratio = section.settings.ratio | default: '1:1' %}
{% assign radius = section.settings.radius | default: 8 %}

<div class='contenedorCarrusel{% if ancho_completo %} contenedorCarrusel--completo{% endif %}'>
  {% if section.settings.titulo != blank %}
    <h2 class='tituloCarrusel'>{{ section.settings.titulo }}</h2>
  {% endif %}

  <div class='carrusel carrusel--{{ estilo_vista }}' data-carrusel>
    {% if section.settings.tipo == 'productos' %}
      {% comment %} Modo manual: usar bloques {% endcomment %}
      {% if section.settings.modo == 'manual' %}
        {% for block in section.blocks %}
          {% if estilo_vista == 'mini-collage' and block.type == 'mini_collage' %}
            {% if block.settings.enlace != blank %}
              <a href='{{ block.settings.enlace }}' class='carruselItem carruselItem--link'>
                {%
                  render 'mini-collage',
                  layout: block.settings.layout | default: 'cuatro',
                  img1: block.settings.img1, alt1: block.settings.alt1,
                  img2: block.settings.img2, alt2: block.settings.alt2,
                  img3: block.settings.img3, alt3: block.settings.alt3,
                  img4: block.settings.img4, alt4: block.settings.alt4,
                  img5: block.settings.img5, alt5: block.settings.alt5,
                  img6: block.settings.img6, alt6: block.settings.alt6,
                  gap: section.settings.gap | default: 12,
                  radius: radius,
                  ratio: ratio
                %}
                {% if block.settings.titulo != blank %}
                  <h3 class='carruselItemTitulo'>{{ block.settings.titulo }}</h3>
                {% endif %}
              </a>
            {% else %}
              <div class='carruselItem'>
                {%
                  render 'mini-collage',
                  layout: block.settings.layout | default: 'cuatro',
                  img1: block.settings.img1, alt1: block.settings.alt1,
                  img2: block.settings.img2, alt2: block.settings.alt2,
                  img3: block.settings.img3, alt3: block.settings.alt3,
                  img4: block.settings.img4, alt4: block.settings.alt4,
                  img5: block.settings.img5, alt5: block.settings.alt5,
                  img6: block.settings.img6, alt6: block.settings.alt6,
                  gap: section.settings.gap | default: 12,
                  radius: radius,
                  ratio: ratio
                %}
                {% if block.settings.titulo != blank %}
                  <h3 class='carruselItemTitulo'>{{ block.settings.titulo }}</h3>
                {% endif %}
              </div>
            {% endif %}
          {% elsif block.type == 'producto' %}
            {% assign prod = all_products[block.settings.producto] %}
            {% if prod %}
              <a href='{{ prod.url }}' class='carruselItem carruselItem--link'>
                {% render 'tarjeta-collage',
                  item: prod,
                  tipo: 'producto',
                  estilo: estilo_vista,
                  ratio: ratio,
                  radius: radius
                %}
                <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% else %}
        {% comment %} Modo automático: productos relacionados {% endcomment %}
        {% assign max_productos = section.settings.limite | default: 8 %}
        {% assign producto_actual = product %}
        {% assign contador = 0 %}
        {% assign ids_mostrados = '' %}

        {% comment %} 1. Primero buscar en la misma colección {% endcomment %}
        {% if producto_actual.collections.first %}
          {% assign coleccion_principal = producto_actual.collections.first %}
          {% for prod in coleccion_principal.products limit: 20 %}
            {% if prod.id != producto_actual.id and contador < max_productos %}
              <a href='{{ prod.url }}' class='carruselItem carruselItem--link'>
                {% render 'tarjeta-collage',
                  item: prod,
                  tipo: 'producto',
                  estilo: estilo_vista,
                  ratio: ratio,
                  radius: radius
                %}
                <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
              </a>
              {% assign contador = contador | plus: 1 %}
              {% assign ids_mostrados = ids_mostrados | append: prod.id | append: ',' %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% comment %} 2. Si no hay suficientes, completar con productos que comparten tags {% endcomment %}
        {% if contador < max_productos and producto_actual.tags.size > 0 %}
          {% for prod in collections.all.products limit: 50 %}
            {% if prod.id != producto_actual.id and contador < max_productos %}
              {% assign id_str = prod.id | append: ',' %}
              {% unless ids_mostrados contains id_str %}
                {% assign tiene_tag_comun = false %}
                {% for tag in prod.tags %}
                  {% if producto_actual.tags contains tag %}
                    {% assign tiene_tag_comun = true %}
                    {% break %}
                  {% endif %}
                {% endfor %}

                {% if tiene_tag_comun %}
                  <a href='{{ prod.url }}' class='carruselItem carruselItem--link'>
                    {% render 'tarjeta-collage',
                      item: prod,
                      tipo: 'producto',
                      estilo: estilo_vista,
                      ratio: ratio,
                      radius: radius
                    %}
                    <h3 class='carruselItemTitulo'>{{ prod.title }}</h3>
                  </a>
                  {% assign contador = contador | plus: 1 %}
                  {% assign ids_mostrados = ids_mostrados | append: prod.id | append: ',' %}
                {% endif %}
              {% endunless %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endif %}

    {% elsif section.settings.tipo == 'colecciones' %}
      {% for block in section.blocks %}
        {% if estilo_vista == 'mini-collage' and block.type == 'mini_collage' %}
          {% if block.settings.enlace != blank %}
            <a href='{{ block.settings.enlace }}' class='carruselItem carruselItem--link'>
              {%
                render 'mini-collage',
                layout: block.settings.layout | default: 'cuatro',
                img1: block.settings.img1, alt1: block.settings.alt1,
                img2: block.settings.img2, alt2: block.settings.alt2,
                img3: block.settings.img3, alt3: block.settings.alt3,
                img4: block.settings.img4, alt4: block.settings.alt4,
                img5: block.settings.img5, alt5: block.settings.alt5,
                img6: block.settings.img6, alt6: block.settings.alt6,
                gap: section.settings.gap | default: 12,
                radius: radius,
                ratio: ratio
              %}
              {% if block.settings.titulo != blank %}
                <h3 class='carruselItemTitulo'>{{ block.settings.titulo }}</h3>
              {% endif %}
            </a>
          {% else %}
            <div class='carruselItem'>
              {%
                render 'mini-collage',
                layout: block.settings.layout | default: 'cuatro',
                img1: block.settings.img1, alt1: block.settings.alt1,
                img2: block.settings.img2, alt2: block.settings.alt2,
                img3: block.settings.img3, alt3: block.settings.alt3,
                img4: block.settings.img4, alt4: block.settings.alt4,
                img5: block.settings.img5, alt5: block.settings.alt5,
                img6: block.settings.img6, alt6: block.settings.alt6,
                gap: section.settings.gap | default: 12,
                radius: radius,
                ratio: ratio
              %}
              {% if block.settings.titulo != blank %}
                <h3 class='carruselItemTitulo'>{{ block.settings.titulo }}</h3>
              {% endif %}
            </div>
          {% endif %}
        {% elsif block.type == 'coleccion' %}
          {% assign col = collections[block.settings.coleccion] %}
          {% if col %}
            {% if estilo_vista == 'mini-collage' %}
              {% assign img1 = col.image %}
              {% assign alt1 = col.title %}
              {% assign img2 = blank %}
              {% assign img3 = blank %}
              {% assign img4 = blank %}
              {% assign img5 = blank %}
              {% assign img6 = blank %}
              {% comment %}Marcar uso de variables para el analizador{% endcomment %}
              {% if img1 %}{% endif -%}
              {%- if alt1 %}{% endif %}

              {% assign count_added = 0 %}
              {% for p in col.products limit: 6 %}
                {% if p.featured_image and count_added < 5 %}
                  {% assign count_added = count_added | plus: 1 %}
                  {% case count_added %}
                    {% when 1 -%}
                      {%- assign img2 = p.featured_image -%}
                      {%- assign alt2 = p.title -%}
                      {%- if img2 %}{% endif -%}
                      {%- if alt2 %}{% endif %}
                    {% when 2 -%}
                      {%- assign img3 = p.featured_image -%}
                      {%- assign alt3 = p.title -%}
                      {%- if img3 %}{% endif -%}
                      {%- if alt3 %}{% endif %}
                    {% when 3 -%}
                      {%- assign img4 = p.featured_image -%}
                      {%- assign alt4 = p.title -%}
                      {%- if img4 %}{% endif -%}
                      {%- if alt4 %}{% endif %}
                    {% when 4 -%}
                      {%- assign img5 = p.featured_image -%}
                      {%- assign alt5 = p.title -%}
                      {%- if img5 %}{% endif -%}
                      {%- if alt5 %}{% endif %}
                    {% when 5 -%}
                      {%- assign img6 = p.featured_image -%}
                      {%- assign alt6 = p.title -%}
                      {%- if img6 %}{% endif -%}
                      {%- if alt6 %}{% endif %}
                  {% endcase %}
                {% endif %}
              {% endfor %}

              <a href='{{ col.url }}' class='carruselItem carruselItem--link'>
                {%
                  render 'mini-collage',
                  layout: 'cuatro',
                  img1: img1, alt1: alt1,
                  img2: img2, alt2: alt2,
                  img3: img3, alt3: alt3,
                  img4: img4, alt4: alt4,
                  img5: img5, alt5: alt5,
                  img6: img6, alt6: alt6,
                  gap: section.settings.gap | default: 12,
                  radius: radius,
                  ratio: ratio
                %}
                <h3 class='carruselItemTitulo'>{{ col.title }}</h3>
              </a>
            {% else %}
              <a href='{{ col.url }}' class='carruselItem carruselItem--link'>
                {% render 'tarjeta-collage',
                  item: col,
                  tipo: 'coleccion',
                  estilo: estilo_vista,
                  ratio: ratio,
                  radius: radius
                %}
                <h3 class='carruselItemTitulo'>{{ col.title }}</h3>
              </a>
            {% endif %}
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "Carrusel",
  "settings": [
    {
      "type": "text",
      "id": "titulo",
      "label": "Título",
      "default": "Productos relacionados"
    },
    {
      "type": "select",
      "id": "tipo",
      "label": "Tipo de contenido",
      "default": "productos",
      "options": [
        { "value": "productos", "label": "Productos" },
        { "value": "colecciones", "label": "Colecciones" }
      ]
    },
    {
      "type": "select",
      "id": "modo",
      "label": "Modo de selección",
      "default": "automatico",
      "info": "Automático: muestra productos relacionados de la misma colección o con tags similares. Manual: selecciona productos específicos.",
      "options": [
        { "value": "automatico", "label": "Automático (relacionados)" },
        { "value": "manual", "label": "Manual (bloques)" }
      ]
    },
    {
      "type": "range",
      "id": "limite",
      "label": "Cantidad máxima de productos (modo automático)",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 8
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Separación mini-collage (px)",
      "min": 0,
      "max": 32,
      "step": 1,
      "default": 12
    },
    {
      "type": "checkbox",
      "id": "ancho_completo",
      "label": "Ancho completo de pantalla",
      "default": false,
      "info": "Si está desactivado, usa el ancho del contenido"
    },
    {
      "type": "select",
      "id": "estilo_vista",
      "label": "Estilo de vista",
      "default": "simple",
      "options": [
        { "value": "simple", "label": "Simple (imagen + info)" },
        { "value": "collage", "label": "Collage (solo imagen)" },
        { "value": "mini-collage", "label": "Mini-collage (varias imágenes)" }
      ]
    },
    {
      "type": "select",
      "id": "ratio",
      "label": "Relación de aspecto (solo collage)",
      "default": "1:1",
      "options": [
        { "value": "1:1", "label": "1:1" },
        { "value": "4:3", "label": "4:3" },
        { "value": "3:2", "label": "3:2" },
        { "value": "16:9", "label": "16:9" },
        { "value": "2:3", "label": "2:3 (vertical)" },
        { "value": "3:4", "label": "3:4 (vertical)" },
        { "value": "9:16", "label": "9:16 (vertical)" }
      ]
    },
    {
      "type": "range",
      "id": "radius",
      "label": "Radio de borde (px, solo collage)",
      "min": 0,
      "max": 32,
      "step": 1,
      "default": 8
    }
  ],
  "blocks": [
    {
      "type": "producto",
      "name": "Producto",
      "settings": [
        {
          "type": "product",
          "id": "producto",
          "label": "Seleccionar producto"
        }
      ]
    },
    {
      "type": "coleccion",
      "name": "Colección",
      "settings": [
        {
          "type": "collection",
          "id": "coleccion",
          "label": "Seleccionar colección"
        }
      ]
    },
    {
      "type": "mini_collage",
      "name": "Mini-collage",
      "settings": [
        {
          "type": "select",
          "id": "layout",
          "label": "Diseño",
          "default": "cuatro",
          "options": [
            { "value": "cuatro", "label": "4 imágenes iguales" },
            { "value": "tres_izq_grande", "label": "3 con grande a la izquierda" },
            { "value": "tres_der_grande", "label": "3 con grande a la derecha" },
            { "value": "dos", "label": "2 iguales" },
            { "value": "cinco_T", "label": "5 en T" },
            { "value": "seis", "label": "6 (3x2)" },
            { "value": "seis_grande", "label": "6 con una grande" }
          ]
        },
        {
          "type": "text",
          "id": "titulo",
          "label": "Título (opcional)",
          "info": "Texto que se mostrará debajo del mini-collage"
        },
        {
          "type": "url",
          "id": "enlace",
          "label": "Enlace (opcional)",
          "info": "URL a producto, colección o página"
        },
        { "type": "image_picker", "id": "img1", "label": "Imagen 1" },
        { "type": "text", "id": "alt1", "label": "Alt 1 (opcional)" },
        { "type": "image_picker", "id": "img2", "label": "Imagen 2" },
        { "type": "text", "id": "alt2", "label": "Alt 2 (opcional)" },
        { "type": "image_picker", "id": "img3", "label": "Imagen 3" },
        { "type": "text", "id": "alt3", "label": "Alt 3 (opcional)" },
        { "type": "image_picker", "id": "img4", "label": "Imagen 4" },
        { "type": "text", "id": "alt4", "label": "Alt 4 (opcional)" },
        { "type": "image_picker", "id": "img5", "label": "Imagen 5" },
        { "type": "text", "id": "alt5", "label": "Alt 5 (opcional)" },
        { "type": "image_picker", "id": "img6", "label": "Imagen 6" },
        { "type": "text", "id": "alt6", "label": "Alt 6 (opcional)" }
      ]
    }
  ],
  "max_blocks": 20,
  "presets": [
    {
      "name": "Carrusel"
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .contenedorCarrusel {
    padding: 2rem 0;
  }

  .contenedorCarrusel--completo {
    max-width: 100vw;
    margin-left: calc(50% - 50vw);
    margin-right: calc(50% - 50vw);
  }

  .tituloCarrusel {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
  }

  .carrusel {
    display: flex;
    gap: 1.5rem;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    padding: 0 1rem 1rem;
  }

  .carruselItem {
    flex: 0 0 200px;
    scroll-snap-align: start;
  }

  .carruselItem--link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .carruselItemTitulo {
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
    margin: 1rem auto 0 auto;
    border: 2px solid;
    padding: 0.5rem;
    display: table;
  }

  /* Estilo collage: imágenes más grandes */
  .carrusel--collage .carruselItem {
    flex: 0 0 300px;
  }

  /* Mini-collage: items más anchos para contener varias imágenes */
  .carrusel--mini-collage .carruselItem {
    flex: 0 0 360px;
  }

  @media (max-width: 768px) {
    .carruselItem {
      flex: 0 0 160px;
    }

    .carrusel--collage .carruselItem {
      flex: 0 0 240px;
    }
    .carrusel--mini-collage .carruselItem {
      flex: 0 0 280px;
    }
  }
{% endstylesheet %}
