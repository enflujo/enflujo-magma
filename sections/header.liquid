{% assign instagram = section.settings.instagram %}
{% if instagram != blank %}
  {% assign entrada_instagram = instagram | strip %}
  {% if entrada_instagram contains 'instagram.com' or entrada_instagram contains '://' %}
    {% assign url_instagram = entrada_instagram %}
    {% unless url_instagram contains '://' %}
      {% assign url_instagram = 'https://' | append: url_instagram %}
    {% endunless %}
  {% else %}
    {% assign usuario_instagram = entrada_instagram %}
    {% assign primer_caracter = usuario_instagram | slice: 0, 1 %}
    {% if primer_caracter == '@' %}
      {% assign usuario_instagram = usuario_instagram | remove: '@' %}
    {% endif %}
    {% assign url_instagram = 'https://instagram.com/' | append: usuario_instagram %}
  {% endif %}
{% endif %}

<header
  id='encabezado'
  style='--logo-altura: {% if section.settings.logo_altura_movil_px and request.design_mode %}{{ section.settings.logo_altura_px | default: 33 }}px{% else %}{{ section.settings.logo_altura_px | default: 33 }}px{% endif %}; --logo-altura-movil: {{ section.settings.logo_altura_movil_px | default: section.settings.logo_altura_px | default: 33 }}px; --icono-altura: {{ section.settings.altura_icono_categoria | default: 53 }}px;'
>
  <!-- Botón hamburguesa visible en móvil -->
  <div id='botonHamburguesa' class='botonHamburguesa' aria-expanded='false' aria-label='Abrir menú'>
    <span class='barraHamburguesa'></span>
    <span class='barraHamburguesa'></span>
    <span class='barraHamburguesa'></span>
  </div>

  <h2 class='encabezadoTitulo'>
    {% if section.settings.logo_header %}
      <a
        href='{{ routes.root_url }}'
        class='logoLink'
        aria-label='{{ section.settings.alt_logo | default: shop.name }}'
      >
        {{
          section.settings.logo_header
          | image_url: width: 600
          | image_tag: alt: section.settings.alt_logo
          | default: section.settings.logo_header.alt
        }}
      </a>
    {% else %}
      {{ shop.name | link_to: routes.root_url }}
    {% endif %}
  </h2>

  {% assign es_home = '' %}
  {% if template.name == 'index' %}{% assign es_home = 'home' %}{% endif %}
  {% assign icono_blocks = section.blocks | where: 'type', 'icono_menu' %}
  {% if icono_blocks.size > 0 %}
    {% assign hay_activo = '' %}
    {% comment %}Determinar el identificador actual para comparación{% endcomment %}
    {% assign pagina_actual = '' %}
    {% assign tipo_actual = '' %}
    {% if template.name == 'page' and page.handle %}
      {% assign pagina_actual = page.handle %}
      {% assign tipo_actual = 'pages' %}
    {% elsif template.name == 'collection' and collection.handle %}
      {% assign pagina_actual = collection.handle %}
      {% assign tipo_actual = 'collections' %}
    {% elsif template.name == 'product' and product.handle %}
      {% assign pagina_actual = product.handle %}
      {% assign tipo_actual = 'products' %}
    {% endif %}

    {% for bloque in icono_blocks %}
      {% if bloque.settings.destino_url != blank and es_home == '' and pagina_actual != '' %}
        {% assign url_partes = bloque.settings.destino_url | split: '/' %}
        {% for parte in url_partes %}
          {% if parte == tipo_actual %}
            {% assign idx = forloop.index %}
            {% assign handle_url = url_partes[idx] %}
            {% if handle_url == pagina_actual %}
              {% assign hay_activo = 'si' %}
              {% break %}
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endfor %}
    <nav
      class='encabezadoIconos encabezadoIconos--categorias{% if hay_activo != '' and es_home == '' %} categorias--conActivo{% endif %}'
      aria-label='Categorías'
      data-template='{{ template.name }}'
      data-page-handle='{{ page.handle }}'
    >
      {% for bloque in icono_blocks %}
        {% assign titulo_icono = bloque.settings.titulo_icono %}
        {% assign imagen_icono = bloque.settings.imagen_icono %}
        {% assign anchor_home = bloque.settings.anchor_home %}
        {% assign destino_url = bloque.settings.destino_url %}

        {% if es_home != '' and anchor_home != blank %}
          {% assign link_destino = '#' | append: anchor_home %}
        {% else %}
          {% assign link_destino = destino_url %}
        {% endif %}

        {% assign es_activo = false %}
        {% if es_home == '' and destino_url != blank and pagina_actual != '' %}
          {% assign url_partes = destino_url | split: '/' %}
          {% for parte in url_partes %}
            {% if parte == tipo_actual %}
              {% assign idx = forloop.index %}
              {% assign handle_url = url_partes[idx] %}
              {% if handle_url == pagina_actual %}
                {% assign es_activo = true %}
                {% break %}
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}

        <a
          href='{{ link_destino }}'
          class='iconoCategoria{% if es_activo %} iconoCategoria--activo{% endif %}'
          {% if es_home != '' and anchor_home != blank %}
            data-scroll='true'
          {% endif %}
          title='{{ titulo_icono }}'
        >
          {% if imagen_icono %}
            {{ imagen_icono | image_url: width: 200 | image_tag: alt: titulo_icono | default: imagen_icono.alt }}
          {% endif %}
          {% if titulo_icono != blank %}
            <span class='iconoCategoria__titulo'>{{ titulo_icono }}</span>
          {% endif %}
        </a>
      {% endfor %}
    </nav>
  {% endif %}

  <div class='encabezadoMenu'>
    {% for link in linklists['main-menu'].links %}
      <a href='{{ link.url }}'>{{ link.title }}</a>
    {% endfor %}
    <!-- Iconos se mostrarán aquí en móvil -->
    <div class='encabezadoIconos encabezadoIconos--menu'>
      {% if instagram != blank %}
        <div class='encabezadoSocial'>
          <a href='{{ url_instagram }}' target='_blank' rel='noopener noreferrer'>
            <img src='{{ 'icono-instagram.svg' | asset_url }}' alt='Instagram' width='30px' height='30px'>
          </a>
        </div>
      {% endif %}

      {% if shop.customer_accounts_enabled %}
        {{ 'icono-account.svg' | inline_asset_content | link_to: routes.account_url }}
      {% endif %}

      <a href='{{ routes.cart_url }}'>
        {% if cart.item_count > 0 %}
          <sup class='contadorCarrito' data-contador-carrito>{{ cart.item_count }}</sup>
        {% endif %}
        {{ 'icono-cart.svg' | inline_asset_content }}
      </a>
    </div>
  </div>
  <!-- Iconos duplicados removidos en desktop via CSS -->
  <div class='encabezadoIconos'>
    {% if instagram != blank %}
      <div class='encabezadoSocial'>
        <a href='{{ url_instagram }}' target='_blank' rel='noopener noreferrer'>
          <img src='{{ 'icono-instagram.svg' | asset_url }}' alt='Instagram' width='30px' height='30px'>
        </a>
      </div>
    {% endif %}

    {% if shop.customer_accounts_enabled %}
      {{ 'icono-account.svg' | inline_asset_content | link_to: routes.account_url }}
    {% endif %}

    <a href='{{ routes.cart_url }}'>
      {% if cart.item_count > 0 %}
        <sup class='contadorCarrito' data-contador-carrito>{{ cart.item_count }}</sup>
      {% endif %}
      {{ 'icono-cart.svg' | inline_asset_content }}
    </a>
  </div>
</header>

{% schema %}
{
  "name": "t:general.header",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo_header",
      "label": "Logo del encabezado (opcional)",
      "info": "Si se define, se muestra en lugar del nombre de la tienda."
    },
    {
      "type": "text",
      "id": "alt_logo",
      "label": "Alt del logo (accesibilidad)",
      "info": "Texto alternativo para el logo. Si se deja vacío, se usa el nombre de la tienda."
    },
    {
      "type": "range",
      "id": "logo_altura_px",
      "label": "Altura del logo (px)",
      "min": 20,
      "max": 120,
      "step": 1,
      "default": 33,
      "info": "Controla la altura del logo en píxeles. El ancho se ajusta proporcionalmente."
    },
    {
      "type": "range",
      "id": "logo_altura_movil_px",
      "label": "Altura del logo en móvil (px)",
      "min": 20,
      "max": 120,
      "step": 1,
      "default": 33,
      "info": "Opcional: altura específica para pantallas ≤768px. Si se deja vacío, se usa la altura de escritorio."
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "t:labels.menu"
    },
    {
      "type": "range",
      "id": "altura_icono_categoria",
      "label": "Altura de íconos de categoría (px)",
      "min": 20,
      "max": 100,
      "step": 1,
      "default": 53,
      "info": "Controla la altura de los íconos del menú de categorías. Por defecto es 2/3 de la altura del encabezado (53px para header de 80px)."
    },
    {
      "type": "text",
      "id": "instagram",
      "label": "Instagram (usuario o URL)",
      "info": "Introduce tu nombre de usuario o pega la URL completa."
    }
  ],
  "blocks": [
    {
      "type": "icono_menu",
      "name": "Ícono de categoría",
      "settings": [
        { "type": "image_picker", "id": "imagen_icono", "label": "Ícono" },
        {
          "type": "text",
          "id": "titulo_icono",
          "label": "Título del ícono",
          "info": "Se muestra al pasar el cursor sobre el ícono."
        },
        {
          "type": "text",
          "id": "anchor_home",
          "label": "ID de ancla en Home",
          "info": "Ej: jewelry, prints. Debe existir un elemento con id='jewelry' en la sección destino."
        },
        {
          "type": "url",
          "id": "destino_url",
          "label": "URL en otras páginas",
          "info": "Ej: /pages/jewelry, /collections/rings. Se usa para navegación y para detectar automáticamente cuál ícono resaltar."
        }
      ]
    }
  ]
}
{% endschema %}

{% stylesheet %}
  header {
    height: 5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: fixed;
    z-index: 999;
    width: 100vw;
    left: 0;
    padding: 0 100px;
    transition:
      background-color 220ms ease,
      box-shadow 220ms ease,
      backdrop-filter 220ms ease;
  }

  header a {
    position: relative;
    text-decoration: none;
    color: var(--color-foreground);
  }

  header a sup {
    position: absolute;
    left: 100%;
    overflow: hidden;
    max-width: 90vw;
  }

  header svg {
    width: 2rem;
  }
  /* Menú de iconos de categorías */
  .encabezadoIconos--categorias {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-left: 1.5rem;
  }
  .iconoCategoria {
    display: inline-flex;
    position: relative;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: var(--color-foreground);
    opacity: 0.85;
    transition:
      opacity 160ms ease,
      transform 160ms ease;
  }
  .iconoCategoria img {
    height: var(--icono-altura, 53px);
    width: auto;
    max-width: 100px;
    object-fit: contain;
    display: block;
  }
  .iconoCategoria__titulo {
    position: absolute;
    bottom: -1.5rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.75rem;
    white-space: nowrap;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 160ms ease;
  }
  .iconoCategoria:hover .iconoCategoria__titulo {
    opacity: 1;
  }
  .iconoCategoria:hover {
    opacity: 1;
    transform: translateY(-1px);
  }
  .iconoCategoria--activo {
    opacity: 1;
  }
  .categorias--conActivo .iconoCategoria:not(.iconoCategoria--activo) {
    opacity: 0.6;
  }

  header .encabezadoMenu {
    display: flex;
    gap: 1rem;
  }
  /* Solo el contenedor de iconos de primer nivel en escritorio */
  header > .encabezadoIconos {
    display: flex;
    gap: 1rem;
  }
  /* Ocultar grupo de iconos anidado dentro del menú por defecto (escritorio) */
  header .encabezadoMenu .encabezadoIconos {
    display: none;
  }

  .encabezadoTitulo {
    text-align: left;
    font-weight: bold;
    margin: 0;
  }

  .logoLink img {
    height: var(--logo-altura, 33px);
    width: auto;
    display: block;
  }

  .botonHamburguesa {
    display: none;
    background: transparent;
    border: 0;
    padding: 0.5rem;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-direction: column;
  }

  .barraHamburguesa {
    display: block;
    width: 22px;
    height: 2px;
    background: #130808;
    margin: 4px 0;
  }

  header.conFondo {
    background-color: rgba(255, 255, 255, 0.85);
    backdrop-filter: saturate(150%) blur(8px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
  }

  @media (max-width: 768px) {
    header {
      padding: 0 1rem;
      --logo-altura: var(--logo-altura-movil, 33px);
    }

    header .encabezadoTitulo {
      order: 1;
      flex: 1 1 auto;
    }
    header .botonHamburguesa {
      order: 2;
      margin-left: auto;
    }

    header .encabezadoMenu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      flex-direction: column;
      padding: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      z-index: 998;
      gap: 0;
    }

    header .encabezadoMenu a {
      padding: 1rem;
      display: block;
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      text-align: center;
    }

    header .botonHamburguesa {
      display: flex;
    }

    header.abierto .encabezadoMenu {
      display: flex;
    }

    header > .encabezadoIconos {
      display: none;
    }

    header .encabezadoMenu .encabezadoIconos {
      display: flex;
      gap: 1rem;
      justify-content: center;
      align-items: center;
      padding: 0.75rem 1rem;
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }
  }
{% endstylesheet %}

<script>
  (function () {
    'use strict';

    function initSmoothScroll() {
      const linksConScroll = document.querySelectorAll('a[data-scroll="true"]');

      linksConScroll.forEach(function (link) {
        link.addEventListener('click', function (e) {
          const href = this.getAttribute('href');
          if (href && href.startsWith('#')) {
            e.preventDefault();
            const targetId = href.substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
              const header = document.querySelector('header');
              const headerHeight = header ? header.offsetHeight : 80;
              const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - headerHeight;
              window.scrollTo({ top: targetPosition, behavior: 'smooth' });
            }
          }
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSmoothScroll);
    } else {
      initSmoothScroll();
    }
  })();
</script>
